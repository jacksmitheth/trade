# backend/data_fetcher.py

import requests
import time
from datetime import datetime, timedelta
from config import APIConfig

class CryptoDataFetcher:
    """Handles all API calls to CoinGecko for cryptocurrency data."""
    
    def init(self):
        self.base_url = APIConfig.COINGECKO_BASE_URL
        self.session = requests.Session()
        
    def _make_request(self, endpoint, params=None):
        """Make an API request with rate limiting and error handling."""
        url = f"{self.base_url}/{endpoint}"
        
        # Rate limiting to avoid API throttling
        time.sleep(APIConfig.RATE_LIMIT_DELAY)
        
        try:
            response = self.session.get(url, params=params, timeout=30)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"API Request Error: {e}")
            return None
    
    def get_market_data(self, currency='usd'):
        """Fetch current market data for all supported coins."""
        params = {
            'vs_currency': currency,
            'order': 'market_cap_desc',
            'per_page': len(APIConfig.SUPPORTED_COINS),
            'page': 1,
            'sparkline': False,
            'price_change_percentage': '24h,7d,30d'
        }
        
        data = self._make_request('coins/markets', params)
        return data if data else []
    
    def get_historical_data(self, coin_id, days=90, currency='usd'):
        """
        Fetch historical price data for technical analysis.
        Returns price history with timestamps.
        """
        params = {
            'vs_currency': currency,
            'days': days,
            'interval': 'daily'
        }
        
        endpoint = f"coins/{coin_id}/market_chart"
        data = self._make_request(endpoint, params)
        
        if data and 'prices' in data:
            prices = data['prices']
            volumes = data.get('market_caps', [])
            
            # Transform data into DataFrame-friendly format
            processed_data = []
            for i, price_point in enumerate(prices):
                timestamp = datetime.fromtimestamp(price_point[0] / 1000)
                price = price_point[1]
                volume = volumes[i][1] if i < len(volumes) else 0
                
                processed_data.append({
                    'timestamp': timestamp,
                    'price': price,
                    'volume': volume
                })
            
            return processed_data
        
        return []
    
    def get_global_data(self):
        """Fetch global cryptocurrency market data."""
        data = self._make_request('global')
        return data['data'] if data else None
    
    def get_coin_details(self, coin_id):
        """Fetch detailed information about a specific coin."""
        data = self._make_request(f'coins/{coin_id}')
        return data if data else None
